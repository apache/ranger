# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

ARG RANGER_BASE_IMAGE
ARG RANGER_BASE_VERSION
FROM ${RANGER_BASE_IMAGE}:${RANGER_BASE_VERSION}

# Declare ARG for use in this build stage
ARG RANGER_VERSION
ARG KERBEROS_ENABLED

# Install required packages including Kerberos client
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    vim \
    net-tools \
    krb5-user \
    && rm -rf /var/lib/apt/lists/*

# Volume for keytabs
VOLUME /etc/keytabs

# Set up working directory
WORKDIR /opt/ranger-audit-consumer-hdfs

# Copy ranger-audit-consumer-hdfs distribution
COPY ./dist/ranger-${RANGER_VERSION}-ranger-audit-consumer-hdfs.tar.gz /tmp/

# Copy scripts, Hadoop configs, and Kerberos configuration
COPY ./scripts/audit-server/service-check-functions.sh           ${RANGER_SCRIPTS}/
COPY ./scripts/audit-server/ranger-audit-consumer-hdfs.sh        ${RANGER_SCRIPTS}/
COPY ./scripts/kdc/krb5.conf /etc/krb5.conf

# Extract and setup
RUN tar xzf /tmp/ranger-${RANGER_VERSION}-ranger-audit-consumer-hdfs.tar.gz -C /opt/ranger-audit-consumer-hdfs --strip-components=1 && \
    rm -f /tmp/ranger-${RANGER_VERSION}-ranger-audit-consumer-hdfs.tar.gz && \
    mkdir -p /var/log/ranger/ranger-audit-consumer-hdfs && \
    mkdir -p /home/ranger/scripts && \
    rm -rf /opt/ranger-audit-consumer-hdfs/logs && \
    ln -sf /var/log/ranger/ranger-audit-consumer-hdfs /opt/ranger-audit-consumer-hdfs/logs && \
    chown -R ranger:ranger /opt/ranger-audit-consumer-hdfs/ /var/log/ranger/ ${RANGER_SCRIPTS} && \
    chmod -R 755 /opt/ranger-audit-consumer-hdfs && \
    chmod 755 ${RANGER_SCRIPTS}/ranger-audit-consumer-hdfs.sh

# Set Java home
ENV JAVA_HOME=/opt/java/openjdk
ENV PATH=$JAVA_HOME/bin:$PATH

# Environment variables for HDFS consumer
ENV AUDIT_CONSUMER_HOME_DIR=/opt/ranger-audit-consumer-hdfs
ENV AUDIT_CONSUMER_CONF_DIR=/opt/ranger-audit-consumer-hdfs/conf
ENV AUDIT_CONSUMER_LOG_DIR=/var/log/ranger/ranger-audit-consumer-hdfs
ENV RANGER_USER=ranger

# Expose health check port
EXPOSE 7092

# Health check - test the health endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f -o /dev/null -s -w "%{http_code}" http://localhost:7092/api/health | grep -q "200" || exit 1

# Environment variable for Kerberos support
ENV KERBEROS_ENABLED=${KERBEROS_ENABLED:-false}

# Switch to ranger user
USER ranger

# Start the HDFS consumer using the custom startup script
WORKDIR /opt/ranger-audit-consumer-hdfs
ENTRYPOINT ["/home/ranger/scripts/ranger-audit-consumer-hdfs.sh"]
