# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

ARG RANGER_BASE_IMAGE
ARG RANGER_BASE_VERSION
FROM ${RANGER_BASE_IMAGE}:${RANGER_BASE_VERSION}

# Declare ARG for use in this build stage
ARG RANGER_VERSION
ARG KERBEROS_ENABLED

# Install required packages including Kerberos client
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    vim \
    net-tools \
    krb5-user \
    && rm -rf /var/lib/apt/lists/*

# Volume for keytabs
VOLUME /etc/keytabs

# Set up working directory
WORKDIR /opt/ranger-audit

# Copy audit-webapp distribution
COPY ./dist/ranger-${RANGER_VERSION}-audit-webapp.tar.gz /tmp/

# Copy setup scripts and Kerberos configuration
COPY ./scripts/audit/ranger-audit-setup.sh  ${RANGER_SCRIPTS}/
COPY ./scripts/audit/ranger-audit.sh        ${RANGER_SCRIPTS}/
COPY ./scripts/wait_for_keytab.sh           ${RANGER_SCRIPTS}/
COPY ./scripts/kdc/krb5.conf /etc/krb5.conf

# Extract and setup
RUN tar xzf /tmp/ranger-${RANGER_VERSION}-audit-webapp.tar.gz -C /opt/ranger-audit --strip-components=1 && \
    rm -f /tmp/ranger-${RANGER_VERSION}-audit-webapp.tar.gz && \
    mkdir -p /opt/ranger-audit/logs && \
    mkdir -p /var/log/audit-server/audit/spool && \
    mkdir -p /var/log/audit-server/audit/archive && \
    mkdir -p /var/log/ranger/audit-server && \
    mkdir -p /home/ranger/scripts && \
    chown -R ranger:ranger /opt/ranger-audit/ /var/log/audit-server/ /var/log/ranger/ ${RANGER_SCRIPTS} && \
    chmod -R 755 /opt/ranger-audit && \
    chmod 755 ${RANGER_SCRIPTS}/ranger-audit-setup.sh && \
    chmod 755 ${RANGER_SCRIPTS}/ranger-audit.sh && \
    chmod 755 ${RANGER_SCRIPTS}/wait_for_keytab.sh

# Set Java home
ENV JAVA_HOME=/opt/java/openjdk
ENV PATH=$JAVA_HOME/bin:$PATH

# Environment variables for audit server
ENV AUDIT_SERVER_HOME_DIR=/opt/ranger-audit
ENV AUDIT_SERVER_CONF_DIR=/opt/ranger-audit/conf
ENV AUDIT_SERVER_LOG_DIR=/var/log/ranger/audit-server
ENV RANGER_USER=ranger

# Expose ports
EXPOSE 7081 7182

# Health check - test the REST API endpoint (returns 401 when auth is required, which means it's healthy)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f -o /dev/null -s -w "%{http_code}" http://localhost:7081/api/audit/health | grep -q -E "200|401" || exit 1

# Environment variable for Kerberos support
ENV KERBEROS_ENABLED=${KERBEROS_ENABLED:-false}

# Switch to ranger user
USER ranger

# Start the audit server using the custom startup script
WORKDIR /opt/ranger-audit
ENTRYPOINT ["/home/ranger/scripts/ranger-audit.sh"]
