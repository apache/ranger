From e7c99334d1b6247ddd68432a216cd810f3eb28ac Mon Sep 17 00:00:00 2001
From: hervor <htao@tencent.com>
Date: Thu, 21 Oct 2021 11:40:46 +0800
Subject: [PATCH 1/1] RANGER-3491: fix not find TAG serviceDef when loading
 service-defs json file

---
 ...RangerPolicy-Data-Not-Found-for-give.patch | 100 ++++++++++++++++++
 .../plugin/store/EmbeddedServiceDefsUtil.java |   5 +-
 2 files changed, 104 insertions(+), 1 deletion(-)
 create mode 100644 0001-RANGER-3486-fix-RangerPolicy-Data-Not-Found-for-give.patch

diff --git a/0001-RANGER-3486-fix-RangerPolicy-Data-Not-Found-for-give.patch b/0001-RANGER-3486-fix-RangerPolicy-Data-Not-Found-for-give.patch
new file mode 100644
index 000000000..fdd07761d
--- /dev/null
+++ b/0001-RANGER-3486-fix-RangerPolicy-Data-Not-Found-for-give.patch
@@ -0,0 +1,100 @@
+From 30f88626d34209e1acbdd6a67e68ef1f0c61ed60 Mon Sep 17 00:00:00 2001
+From: hervor <htao@tencent.com>
+Date: Wed, 20 Oct 2021 16:10:15 +0800
+Subject: [PATCH 1/1] RANGER-3486:fix RangerPolicy Data Not Found for given id
+ when grantAccess and revokeAccess
+
+---
+ .../policyengine/RangerPolicyRepository.java  |  2 +-
+ .../ranger/biz/RangerPolicyAdminImpl.java     | 45 +++++++++++++------
+ 2 files changed, 32 insertions(+), 15 deletions(-)
+
+diff --git a/agents-common/src/main/java/org/apache/ranger/plugin/policyengine/RangerPolicyRepository.java b/agents-common/src/main/java/org/apache/ranger/plugin/policyengine/RangerPolicyRepository.java
+index 008ee7719..07c0688ae 100644
+--- a/agents-common/src/main/java/org/apache/ranger/plugin/policyengine/RangerPolicyRepository.java
++++ b/agents-common/src/main/java/org/apache/ranger/plugin/policyengine/RangerPolicyRepository.java
+@@ -654,7 +654,7 @@ void storeAuditEnabledInCache(RangerAccessRequest request, RangerAccessResult re
+     }
+ 
+ 
+-    Map<Long, RangerPolicyEvaluator> getPolicyEvaluatorsMap() { return policyEvaluatorsMap; }
++    public Map<Long, RangerPolicyEvaluator> getPolicyEvaluatorsMap() { return policyEvaluatorsMap; }
+ 
+     RangerPolicyEvaluator getPolicyEvaluator(Long id) {
+         return policyEvaluatorsMap.get(id);
+diff --git a/security-admin/src/main/java/org/apache/ranger/biz/RangerPolicyAdminImpl.java b/security-admin/src/main/java/org/apache/ranger/biz/RangerPolicyAdminImpl.java
+index 5311a54a2..56ea45688 100644
+--- a/security-admin/src/main/java/org/apache/ranger/biz/RangerPolicyAdminImpl.java
++++ b/security-admin/src/main/java/org/apache/ranger/biz/RangerPolicyAdminImpl.java
+@@ -279,16 +279,24 @@ boolean isDelegatedAdminAccessAllowed(RangerPolicy policy, String user, Set<Stri
+ 
+             RangerPolicyRepository policyRepository = policyEngine.getRepositoryForZone(zoneName);
+ 
+-            if (policyRepository != null) {
+-                for (RangerPolicyEvaluator evaluator : policyRepository.getPolicyEvaluators()) {
+-                    if (evaluator.isCompleteMatch(resource, evalContext)) {
+-                        if (ret == null) {
+-                            ret = new ArrayList<>();
+-                        }
++            if (policyRepository != null ) {
+ 
+-                        ret.add(evaluator.getPolicy());
++                Map<Long, RangerPolicyEvaluator>  policyEvaluatorsMap = policyRepository.getPolicyEvaluatorsMap();
++
++                if (!policyEvaluatorsMap.isEmpty()) {
++
++                    for (RangerPolicyEvaluator evaluator : policyEvaluatorsMap.values()) {
++                        if (evaluator.isCompleteMatch(resource, evalContext)) {
++                            if (ret == null) {
++                                ret = new ArrayList<>();
++                            }
++
++                            ret.add(evaluator.getPolicy());
++                        }
+                     }
++
+                 }
++
+             }
+ 
+         }
+@@ -318,20 +326,29 @@ boolean isDelegatedAdminAccessAllowed(RangerPolicy policy, String user, Set<Stri
+ 
+             RangerPolicyRepository policyRepository = policyEngine.getRepositoryForMatchedZone(policy);
+ 
+-            if (policyRepository != null) {
++            if (policyRepository != null ) {
++
++                Map<Long, RangerPolicyEvaluator>  policyEvaluatorsMap = policyRepository.getPolicyEvaluatorsMap();
++
+                 Map<String, RangerPolicyResource> resources = policy.getResources();
+ 
+-                for (RangerPolicyEvaluator evaluator : policyRepository.getPolicyEvaluators()) {
+-                    if (evaluator.isCompleteMatch(resources, evalContext)) {
+-                        if (ret == null) {
+-                            ret = new ArrayList<>();
+-                        }
++                if (!policyEvaluatorsMap.isEmpty()) {
+ 
+-                        ret.add(evaluator.getPolicy());
++                    for (RangerPolicyEvaluator evaluator : policyEvaluatorsMap.values()) {
++                        if (evaluator.isCompleteMatch(resources, evalContext)) {
++                            if (ret == null) {
++                                ret = new ArrayList<>();
++                            }
++
++                            ret.add(evaluator.getPolicy());
++                        }
+                     }
++
+                 }
++
+             }
+ 
++
+         }
+ 
+         if (LOG.isDebugEnabled()) {
+-- 
+2.33.0
+
diff --git a/agents-common/src/main/java/org/apache/ranger/plugin/store/EmbeddedServiceDefsUtil.java b/agents-common/src/main/java/org/apache/ranger/plugin/store/EmbeddedServiceDefsUtil.java
index 7775b0871..ed08ee099 100755
--- a/agents-common/src/main/java/org/apache/ranger/plugin/store/EmbeddedServiceDefsUtil.java
+++ b/agents-common/src/main/java/org/apache/ranger/plugin/store/EmbeddedServiceDefsUtil.java
@@ -144,6 +144,9 @@ public void init(ServiceStore store) {
 			 * Maintaining the following service-def create-order is critical for the
 			 * the legacy service-defs (HDFS/HBase/Hive/Knox/Storm) to be assigned IDs
 			 * that were used in earlier version (0.4) */
+
+			tagServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_TAG_NAME);
+
 			hdfsServiceDef  = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_HDFS_NAME);
 			hBaseServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_HBASE_NAME);
 			hiveServiceDef  = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_HIVE_NAME);
@@ -158,7 +161,7 @@ public void init(ServiceStore store) {
 			nifiRegistryServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_NIFI_REGISTRY_NAME);
 			atlasServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_ATLAS_NAME);
 
-			tagServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_TAG_NAME);
+
 			wasbServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_WASB_NAME);
 			sqoopServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_SQOOP_NAME);
 			kylinServiceDef = getOrCreateServiceDef(store, EMBEDDED_SERVICEDEF_KYLIN_NAME);
-- 
2.33.0

